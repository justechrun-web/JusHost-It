
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      // In a real app, this would check a custom claim or a separate 'roles' collection.
      // For this demo, we check a field on the user document.
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isConsistentOwnerOnCreate(userId) {
      return isOwner(userId) && request.resource.data.userId == userId;
    }

    function isOwnerFieldImmutable() {
      return resource.data.userId == request.resource.data.userId;
    }
    
    function isStatusTransitionAllowed() {
      // Users can suspend or resume their own sites.
      // Only admins can change status to/from 'provisioning' or 'error'.
      let isUserAction = (request.resource.data.status == 'suspended' && resource.data.status == 'active') || (request.resource.data.status == 'active' && resource.data.status == 'suspended');
      let isAdminAction = isAdmin();
      return isUserAction || isAdminAction;
    }
    
    function canCreateSite(userId) {
        let user = get(/databases/$(database)/documents/users/$(userId)).data;
        let plan = user.plan;
        // This simulates a call to get a count, but in rules we'd often denormalize this count
        // onto the user document itself for efficiency. For this example, we assume `sites` is a denormalized count.
        let currentSites = user.sites; 

        if (plan == 'basic') {
            return currentSites < 1;
        } else if (plan == 'pro') {
            return currentSites < 5;
        } else if (plan == 'business') {
            return true; // Unlimited
        }
        return false;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------
    
    match /sites/{siteId} {
        allow get, list: if isAdmin();
    }
    
    match /orgs/{orgId} {
      allow get: if isSignedIn();
      allow list, create, update, delete: if isAdmin();
    }


    match /users/{userId} {
      // Users can read their own document. Admins can read any.
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin(); // Only admins can list users.
      
      // Prevent client-side writes to sensitive fields to enforce server-side logic (e.g. from webhooks)
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && 
                      request.resource.data.plan == resource.data.plan &&
                      request.resource.data.subscriptionStatus == resource.data.subscriptionStatus &&
                      request.resource.data.role == resource.data.role &&
                      request.resource.data.hardCap == resource.data.hardCap;
      allow delete: if false;


        match /sites/{siteId} {
          allow get, list: if isOwner(userId) || isAdmin();
          // Allow creation only if user is owner AND their plan allows for more sites.
          allow create: if isConsistentOwnerOnCreate(userId) && canCreateSite(userId);
          // Allow owner to suspend/resume. Admins can do anything.
          allow update: if (isOwner(userId) && isOwnerFieldImmutable() && isStatusTransitionAllowed()) || isAdmin();
          allow delete: if isOwner(userId) || isAdmin();
        }

        match /billingSubscriptions/{billingId} {
          allow get, list: if isOwner(userId) || isAdmin();
          // Managed by backend (Stripe webhooks)
          allow create, update, delete: if false; 
        }

        match /supportTickets/{ticketId} {
          allow get, list: if isOwner(userId) || isAdmin();
          allow create: if isConsistentOwnerOnCreate(userId);
          allow update: if (isOwner(userId) && isOwnerFieldImmutable()) || isAdmin();
          allow delete: if isOwner(userId) || isAdmin();
        }

        match /login_events/{eventId} {
            allow get, list: if isOwner(userId) || isAdmin();
            // Can only be created by the backend on behalf of the user
            allow create: if isConsistentOwnerOnCreate(userId);
            // Events are immutable
            allow update, delete: if false; 
        }
    }
  }
}
